<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace - CodeDesign Marketplace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="navbar-root"></div>

    <main>
        <div class="container" style="padding: 2rem 0;">
            <!-- Project Header -->
            <div id="projectHeader" style="background: white; border-radius: var(--radius-xl); padding: 2rem; box-shadow: var(--shadow-md); margin-bottom: 2rem;">
                <h1 id="projectTitle" style="margin: 0 0 0.5rem 0; font-size: 1.75rem; color: var(--text-primary);">Project Workspace</h1>
                <p id="projectDescription" style="margin: 0; color: var(--text-secondary); font-size: 1rem; line-height: 1.6;"></p>
            </div>

            <div id="workspaceMainGrid" style="display: grid; grid-template-columns: 1fr 400px; gap: 2rem;">
                <!-- Left Column: Media Showcase (visible for all) + Chat (only for client) -->
                <div class="workspace-main-panel">
                    <div id="workspaceShowcaseWrapper" class="workspace-showcase-card">
                        <div class="workspace-showcase-header">
                            <div>
                                <p class="workspace-gallery-subtitle">Media showcase</p>
                                <h2>·∫¢nh & video d·ª± √°n</h2>
                            </div>
                            <div class="workspace-showcase-status" id="workspaceShowcaseStatus">
                                <span>Ch∆∞a c√≥ t·ªáp ƒë√≠nh k√®m</span>
                            </div>
                        </div>
                        <div id="workspaceShowcaseGallery" class="workspace-media-gallery" style="min-height: 260px;"></div>
                    </div>

                    <!-- Chat Container (only visible for client) -->
                    <div id="chatContainer" class="workspace-chat-card" style="background: white; border-radius: var(--radius-xl); padding: 1.5rem; box-shadow: var(--shadow-md); margin-top: 1.5rem; height: 500px; display: flex; flex-direction: column;">
                        <div id="messagesList" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; display: flex; flex-direction: column; gap: 0; min-height: 0; width: 100%; box-sizing: border-box;">
                            <!-- Messages will be loaded here -->
                        </div>
                        <div style="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; width: 100%; box-sizing: border-box;">
                            <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex: 1; padding: 0.75rem 1rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); font-size: 0.9375rem; box-sizing: border-box;" onkeypress="if(event.key === 'Enter') { if(typeof sendMessage === 'function') sendMessage(); }">
                            <button class="btn btn-primary" id="sendMessageBtn" style="padding: 0.75rem 1.5rem; flex-shrink: 0;" onclick="if(typeof sendMessage === 'function') sendMessage();">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Control Panel with Tabs (only visible for client) -->
                <div id="controlPanelWrapper">
                    <div class="control-panel" style="background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); overflow: hidden;">
                        <!-- Tabs -->
                        <div class="tabs-container" style="display: flex; border-bottom: 2px solid var(--border-color); background: var(--bg-gray);">
                            <button class="tab-btn active" data-tab="details" data-tab-name="details">
                                <i class="fas fa-info-circle"></i> Chi ti·∫øt
                            </button>
                            <button class="tab-btn" data-tab="bidders" data-tab-name="bidders">
                                <i class="fas fa-users"></i> ·ª®ng vi√™n
                            </button>
                            <button class="tab-btn" data-tab="milestones" data-tab-name="milestones">
                                <i class="fas fa-flag"></i> Milestones
                            </button>
                            <button class="tab-btn" data-tab="files" data-tab-name="files">
                                <i class="fas fa-file"></i> T·ªáp
                            </button>
                            <button class="tab-btn" data-tab="activity" data-tab-name="activity">
                                <i class="fas fa-stream"></i> Ho·∫°t ƒë·ªông
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div class="tab-content" style="padding: 1.5rem;">
                            <!-- Tab: Chi ti·∫øt D·ª± √°n -->
                            <div id="tab-details" class="tab-pane active">
                                <div id="projectDetails">
                                    <!-- Project details will be loaded here -->
                                </div>
                                <!-- Requirements Section (for freelancer to view client answers) -->
                                <div id="projectRequirements" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                                    <h3 style="margin: 0 0 1rem 0; font-size: 1.125rem; color: var(--text-primary);">
                                        <i class="fas fa-question-circle"></i> Y√™u c·∫ßu kh√°ch h√†ng
                                    </h3>
                                    <div id="requirementsDisplay" class="requirements-display">
                                        <!-- Requirements will be loaded here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: ·ª®ng vi√™n -->
                            <div id="tab-bidders" class="tab-pane">
                                <div id="biddersList">
                                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ƒêang t·∫£i...</p>
                                </div>
                            </div>

                            <!-- Tab: Milestones -->
                            <div id="tab-milestones" class="tab-pane">
                                <!-- DEBUG PANEL - Hi·ªÉn th·ªã raw data ƒë·ªÉ ki·ªÉm tra -->
                                <div id="milestonesDebugPanel" style="background: #FFF3CD; border: 2px solid #FFC107; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-family: monospace; font-size: 0.85rem; max-height: 300px; overflow-y: auto;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <strong style="color: #856404;">üîç DEBUG PANEL - Raw API Data</strong>
                                        <button onclick="document.getElementById('milestonesDebugPanel').style.display = 'none';" style="background: #FFC107; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">‚úï ƒê√≥ng</button>
                                    </div>
                                    <div id="milestonesDebugContent" style="color: #856404; white-space: pre-wrap; word-break: break-all;">
                                        ƒêang t·∫£i d·ªØ li·ªáu...
                                    </div>
                                </div>
                                
                                <div id="milestonesList">
                                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ƒêang t·∫£i...</p>
                                </div>
                            </div>

                            <!-- Tab: T·ªáp ƒë√≠nh k√®m -->
                            <div id="tab-files" class="tab-pane">
                                <div id="filesList">
                                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Ch∆∞a c√≥ t·ªáp ƒë√≠nh k√®m.</p>
                                </div>
                            </div>

                            <!-- Tab: Ho·∫°t ƒë·ªông -->
                            <div id="tab-activity" class="tab-pane">
                                <div id="activityList">
                                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ƒêang t·∫£i l·ªãch s·ª≠ ho·∫°t ƒë·ªông...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h2>ƒê√°nh gi√° Freelancer</h2>
                <button class="modal-close" type="button" onclick="closeReviewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="rating-stars" id="ratingStars" style="text-align: center; font-size: 2rem; color: #d1d5db; cursor: pointer; margin-bottom: 1rem;">
                    <span class="star" data-value="1">‚òÖ</span>
                    <span class="star" data-value="2">‚òÖ</span>
                    <span class="star" data-value="3">‚òÖ</span>
                    <span class="star" data-value="4">‚òÖ</span>
                    <span class="star" data-value="5">‚òÖ</span>
                </div>
                <input type="hidden" id="ratingValue" value="0">
                <div class="form-group">
                    <label for="reviewComment">Nh·∫≠n x√©t c·ªßa b·∫°n</label>
                    <textarea id="reviewComment" rows="4" placeholder="H√£y chia s·∫ª tr·∫£i nghi·ªám l√†m vi·ªác c·ªßa b·∫°n..."></textarea>
                </div>
                <button class="btn btn-primary" style="width: 100%;" type="button" onclick="submitReview()">
                    G·ª≠i ƒë√°nh gi√°
                </button>
            </div>
        </div>
    </div>

    <!-- Deliver Modal (for freelancer) -->
    <div id="deliverModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-paper-plane"></i> Giao h√†ng</h2>
                <button class="modal-close" type="button" onclick="closeDeliverModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-muted" style="margin-bottom: 1.5rem;">
                    Vui l√≤ng t·∫£i l√™n c√°c file th√†nh ph·∫©m v√† m√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ c√¥ng vi·ªác ƒë√£ ho√†n th√†nh.
                </p>
                <div class="form-group">
                    <label for="deliverFiles">T·ªáp ƒë√≠nh k√®m <span class="text-danger">*</span></label>
                    <input type="file" id="deliverFiles" class="form-control" multiple accept="image/*,video/*,.pdf,.zip,.rar,.doc,.docx">
                    <small class="form-hint">C√≥ th·ªÉ ch·ªçn nhi·ªÅu file. H·ªó tr·ª£: ·∫£nh, video, PDF, ZIP, DOC</small>
                </div>
                <div class="form-group">
                    <label for="deliverDescription">M√¥ t·∫£ (t√πy ch·ªçn)</label>
                    <textarea id="deliverDescription" rows="4" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ c√¥ng vi·ªác ƒë√£ ho√†n th√†nh, c√°c ƒëi·ªÉm n·ªïi b·∫≠t..."></textarea>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-secondary" style="flex: 1;" type="button" onclick="closeDeliverModal()">
                        H·ªßy
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" type="button" onclick="submitDelivery()">
                        <i class="fas fa-paper-plane"></i> Giao h√†ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Revision Modal (for client) -->
    <div id="requestRevisionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-redo"></i> Y√™u c·∫ßu ch·ªânh s·ª≠a</h2>
                <button class="modal-close" type="button" onclick="closeRequestRevisionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-muted" style="margin-bottom: 1.5rem;">
                    Vui l√≤ng m√¥ t·∫£ r√µ nh·ªØng ƒëi·ªÉm c·∫ßn ch·ªânh s·ª≠a ƒë·ªÉ freelancer c√≥ th·ªÉ c·∫£i thi·ªán s·∫£n ph·∫©m.
                </p>
                <div class="form-group">
                    <label for="revisionReason">L√Ω do y√™u c·∫ßu ch·ªânh s·ª≠a <span class="text-danger">*</span></label>
                    <textarea id="revisionReason" rows="5" placeholder="V√≠ d·ª•: M√†u s·∫Øc ch∆∞a ƒë√∫ng y√™u c·∫ßu, thi·∫øu m·ªôt s·ªë t√≠nh nƒÉng, c·∫ßn ƒëi·ªÅu ch·ªânh layout..."></textarea>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-secondary" style="flex: 1;" type="button" onclick="closeRequestRevisionModal()">
                        H·ªßy
                    </button>
                    <button class="btn btn-warning" style="flex: 1;" type="button" onclick="submitRevisionRequest()">
                        <i class="fas fa-redo"></i> G·ª≠i y√™u c·∫ßu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Work Modal (for freelancer) -->
    <div id="submitWorkModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-paper-plane"></i> N·ªôp s·∫£n ph·∫©m cho Giai ƒëo·∫°n n√†y</h2>
                <button class="modal-close" type="button" onclick="closeSubmitWorkModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="submit_milestone_id">
                
                <p class="text-muted" style="margin-bottom: 1.5rem;">
                    Vui l√≤ng t·∫£i l√™n c√°c file th√†nh ph·∫©m v√† m√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ c√¥ng vi·ªác ƒë√£ ho√†n th√†nh.
                </p>
                
                <div class="form-group">
                    <label for="submit_description">L·ªùi nh·∫Øn g·ª≠i Client:</label>
                    <textarea id="submit_description" rows="3" placeholder="V√≠ d·ª•: Em ƒë√£ ho√†n th√†nh b·∫£n thi·∫øt k·∫ø, anh xem qua file ƒë√≠nh k√®m nh√©..."></textarea>
                </div>

                <div class="form-group">
                    <label for="submit_files">ƒê√≠nh k√®m t·ªáp s·∫£n ph·∫©m:</label>
                    <input type="file" class="form-control" id="submit_files" multiple accept="image/*,video/*,.pdf,.zip,.rar,.doc,.docx">
                    <small class="form-hint">H·ªó tr·ª£: Images, PDF, Zip, Docs... C√≥ th·ªÉ ch·ªçn nhi·ªÅu file.</small>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 0.75rem; padding: 1.5rem; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" style="flex: 1;" type="button" onclick="closeSubmitWorkModal()">
                    H·ªßy
                </button>
                <button class="btn btn-primary" style="flex: 1;" type="button" onclick="confirmSubmitWork()">
                    <i class="fas fa-paper-plane"></i> G·ª≠i ngay
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/workspace.js"></script>
    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');
            if (projectId && typeof loadWorkspace === 'function') {
                loadWorkspace(projectId);
            } else if (projectId) {
                // Retry after a short delay if function not yet loaded
                setTimeout(function() {
                    if (typeof loadWorkspace === 'function') {
                        loadWorkspace(projectId);
                    } else {
                        console.error('loadWorkspace function not found');
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>
